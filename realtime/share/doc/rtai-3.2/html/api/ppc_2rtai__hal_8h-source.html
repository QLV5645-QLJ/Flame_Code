<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: base/include/asm-ppc/rtai_hal.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">base</a>&nbsp;/&nbsp;<a class="el" href="dir_000014.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000018.html">asm-ppc</a></div>
<h1>rtai_hal.h</h1><a href="ppc_2rtai__hal_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00040 <span class="preprocessor">#ifndef _RTAI_ASM_PPC_HAL_H</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_PPC_HAL_H</span>
00042 <span class="preprocessor"></span>
00043 <span class="preprocessor">#include &lt;asm/rtai_vectors.h&gt;</span>
00044 <span class="preprocessor">#include &lt;rtai_types.h&gt;</span>
00045 
00046 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_NR_CPUS  CONFIG_RTAI_CPUS</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_SMP */</span>
00049 <span class="preprocessor">#define RTAI_NR_CPUS  1</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_SMP */</span>
00051 
00052 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> ffnz(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ul) {
00053 
00054         __asm__ __volatile__ (<span class="stringliteral">"cntlzw %0, %1"</span> : <span class="stringliteral">"=r"</span> (ul) : <span class="stringliteral">"r"</span> (ul &amp; (-ul)));
00055 
00056         <span class="keywordflow">return</span> 31 - ul;
00057 }
00058 
00059 <span class="comment">/* One of the silly thing of 32 bits PPCs, no 64 bits result for 32 bits mul. */</span>
00060 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_ullmul(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m0, 
00061                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m1) {
00062 
00063     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> res;
00064     
00065     __asm__ __volatile__ (<span class="stringliteral">"mulhwu %0, %1, %2"</span>
00066                           : <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;res)[0]) 
00067                           : <span class="stringliteral">"%r"</span> (m0), <span class="stringliteral">"r"</span> (m1));
00068     ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;res)[1] = m0*m1;
00069     
00070     <span class="keywordflow">return</span> res;
00071 }
00072 
00073 <span class="comment">/* One of the silly thing of 32 bits PPCs, no 64 by 32 bits divide. */</span>
00074 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_ulldiv(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, 
00075                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uld, 
00076                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *r) {
00077 
00078     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> q, rf;
00079     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> qh, rh, ql, qf;
00080     
00081     q = 0;
00082     rf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)(0xFFFFFFFF - (qf = 0xFFFFFFFF / uld) * uld) + 1ULL;
00083     
00084     <span class="keywordflow">while</span> (ull &gt;= uld) 
00085         {
00086         ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;q)[0] += (qh = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[0] / uld);
00087         rh = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[0] - qh * uld;
00088         q += rh * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)qf + (ql = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[1] / uld);
00089         ull = rh * rf + (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[1] - ql * uld);
00090         }
00091     
00092     *r = ull;
00093     <span class="keywordflow">return</span> q;
00094 }
00095 
00096 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rtai_imuldiv(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mult, <span class="keywordtype">int</span> div) {
00097 
00098     <span class="comment">/* Returns (int)i = (int)i*(int)(mult)/(int)div. */</span>
00099 
00100     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> q, r;
00101     
00102     q = rtai_ulldiv(rtai_ullmul(i, mult), div, &amp;r);
00103     
00104     <span class="keywordflow">return</span> (r + r) &gt; div ? q + 1 : q;
00105 }
00106 
00107 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_llimd(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, 
00108                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mult, 
00109                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> div) {
00110 
00111     <span class="comment">/* Returns (long long)ll = (int)ll*(int)(mult)/(int)div. */</span>
00112 
00113     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> low;
00114     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> q, r;
00115     
00116     low  = rtai_ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[1], mult);       
00117     q = rtai_ulldiv(rtai_ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;ull)[0], mult) + 
00118                 ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;low)[0], div, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;low);
00119     low = rtai_ulldiv(low, div, &amp;r);
00120     ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<span class="keywordtype">void</span> *)&amp;low)[0] += q;
00121     
00122     <span class="keywordflow">return</span> (r + r) &gt; div ? low + 1 : low;
00123 }
00124 
00125 
00126 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; !defined(__cplusplus)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/sched.h&gt;</span>
00128 <span class="preprocessor">#include &lt;asm/system.h&gt;</span>
00129 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
00130 <span class="preprocessor">#include &lt;asm/time.h&gt;</span>
00131 <span class="preprocessor">#include &lt;asm/rtai_atomic.h&gt;</span>
00132 <span class="preprocessor">#include &lt;asm/rtai_fpu.h&gt;</span>
00133 <span class="preprocessor">#include &lt;rtai_trace.h&gt;</span>
00134 
00135 <span class="preprocessor">#define RTAI_DOMAIN_ID  0x52544149</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_NR_SRQS    32</span>
00137 <span class="preprocessor"></span>
00138 <span class="preprocessor">#ifdef FIXME</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SMP_NOTIFY_VECTOR    RTAI_APIC3_VECTOR</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SMP_NOTIFY_IPI       RTAI_APIC3_IPI</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_TIMER_VECTOR    RTAI_APIC4_VECTOR</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_TIMER_IPI       RTAI_APIC4_IPI</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145 <span class="preprocessor">#define RTAI_TIMER_DECR_IRQ       IPIPE_VIRQ_BASE</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_TIMER_8254_IRQ       RTAI_TIMER_DECR_IRQ</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_FREQ_8254            (rtai_tunables.cpu_freq)</span>
00148 <span class="preprocessor"></span><span class="preprocessor">#ifdef FIXME</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_ICOUNT          ((RTAI_FREQ_APIC + HZ/2)/HZ)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_COUNTER_2_LATCH      0xfffe</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_LATENCY_8254         CONFIG_RTAI_SCHED_8254_LATENCY</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SETUP_TIME_8254      500</span>
00154 <span class="preprocessor"></span>
00155 <span class="preprocessor">#ifdef FIXME</span>
00156 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_CALIBRATED_APIC_FREQ 0</span>
00157 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_FREQ_APIC            (rtai_tunables.apic_freq)</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_LATENCY_APIC         CONFIG_RTAI_SCHED_APIC_LATENCY</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SETUP_TIME_APIC      1000</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162 <span class="preprocessor">#define RTAI_TIME_LIMIT           0x7FFFFFFFFFFFFFFFLL</span>
00163 <span class="preprocessor"></span>
00164 <span class="preprocessor">#define RTAI_IFLAG  15</span>
00165 <span class="preprocessor"></span>
00166 <span class="preprocessor">#define rtai_cpuid()  adeos_processor_id()</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#define rtai_tskext   ptd</span>
00168 <span class="preprocessor"></span>
00169 <span class="comment">/* Use these to grant atomic protection when accessing the hardware */</span>
00170 <span class="preprocessor">#define rtai_hw_cli()                  adeos_hw_cli()</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_sti()                  adeos_hw_sti()</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_save_flags_and_cli(x)  adeos_hw_local_irq_save(flags)</span>
00173 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_restore_flags(x)       adeos_hw_local_irq_restore(flags)</span>
00174 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_save_flags(x)          adeos_hw_local_irq_flags(flags)</span>
00175 <span class="preprocessor"></span>
00176 <span class="comment">/* Use these to grant atomic protection in hard real time code */</span>
00177 <span class="preprocessor">#define rtai_cli()                  adeos_hw_cli()</span>
00178 <span class="preprocessor"></span><span class="preprocessor">#define rtai_sti()                  adeos_hw_sti()</span>
00179 <span class="preprocessor"></span><span class="preprocessor">#define rtai_save_flags_and_cli(x)  adeos_hw_local_irq_save(flags)</span>
00180 <span class="preprocessor"></span><span class="preprocessor">#define rtai_restore_flags(x)       adeos_hw_local_irq_restore(flags)</span>
00181 <span class="preprocessor"></span><span class="preprocessor">#define rtai_save_flags(x)          adeos_hw_local_irq_flags(flags)</span>
00182 <span class="preprocessor"></span>
00183 <span class="comment">/* The only Linux irq flags manipulation lacking in its system.h */</span>
00184 <span class="preprocessor">#define local_irq_restore_nosync(flags, cpuid)  do { adp_root-&gt;cpudata[cpuid].status = flags; } while (0)</span>
00185 <span class="preprocessor"></span>
00186 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> adeos_pended;
00187 
00188 <span class="preprocessor">#define adeos_pend_uncond(irq, cpuid) \</span>
00189 <span class="preprocessor">do { \</span>
00190 <span class="preprocessor">        adp_root-&gt;cpudata[cpuid].irq_hits[irq]++; \</span>
00191 <span class="preprocessor">        __set_bit(irq &amp; IPIPE_IRQ_IMASK, &amp;adp_root-&gt;cpudata[cpuid].irq_pending_lo[irq &gt;&gt; IPIPE_IRQ_ISHIFT]); \</span>
00192 <span class="preprocessor">        __set_bit(irq &gt;&gt; IPIPE_IRQ_ISHIFT, &amp;adp_root-&gt;cpudata[cpuid].irq_pending_hi); \</span>
00193 <span class="preprocessor">        __set_bit(cpuid, &amp;adeos_pended); \</span>
00194 <span class="preprocessor">} while (0)</span>
00195 <span class="preprocessor"></span>
00196 <span class="preprocessor">#ifdef CONFIG_PREEMPT</span>
00197 <span class="preprocessor"></span><span class="preprocessor">#define rtai_save_and_lock_preempt_count() \</span>
00198 <span class="preprocessor">        do { int *prcntp, prcnt; prcnt = xchg(prcntp = &amp;preempt_count(), 1);</span>
00199 <span class="preprocessor"></span><span class="preprocessor">#define rtai_restore_preempt_count() \</span>
00200 <span class="preprocessor">             *prcntp = prcnt; } while (0)</span>
00201 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00202 <span class="preprocessor"></span><span class="preprocessor">#define rtai_save_and_lock_preempt_count();</span>
00203 <span class="preprocessor"></span><span class="preprocessor">#define rtai_restore_preempt_count();</span>
00204 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00205 <span class="preprocessor"></span>
00206 <span class="keyword">typedef</span> int (*rt_irq_handler_t)(<span class="keywordtype">unsigned</span> irq, <span class="keywordtype">void</span> *cookie);
00207 
00208 <span class="comment">/* Bits from rtai_status. */</span>
00209 <span class="preprocessor">#define RTAI_USE_APIC  0</span>
00210 <span class="preprocessor"></span>
00211 <span class="preprocessor">#define RTAI_CALIBRATED_CPU_FREQ   0</span>
00212 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_CPU_FREQ             (rtai_tunables.cpu_freq)</span>
00213 <span class="preprocessor"></span>
00214 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_rdtsc (<span class="keywordtype">void</span>) {
00215 
00216         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ts;
00217         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> chk;
00218         <span class="comment">/* See Motorola reference manual for 32 bits PPCs. */</span>
00219         __asm__ __volatile__ (<span class="stringliteral">"1: mftbu %0\n"</span>
00220                               <span class="stringliteral">"   mftb %1\n"</span>
00221                               <span class="stringliteral">"   mftbu %2\n"</span>
00222                               <span class="stringliteral">"   cmpw %2,%0\n"</span>
00223                               <span class="stringliteral">"   bne 1b\n"</span>
00224                               : <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ts)[0]), 
00225                                 <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ts)[1]), 
00226                                 <span class="stringliteral">"=r"</span> (chk));
00227         <span class="keywordflow">return</span> ts;
00228 }
00229 
00230 <span class="keyword">struct </span>calibration_data {
00231 
00232     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cpu_freq;
00233     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> apic_freq;
00234     <span class="keywordtype">int</span> latency;
00235     <span class="keywordtype">int</span> setup_time_TIMER_CPUNIT;
00236     <span class="keywordtype">int</span> setup_time_TIMER_UNIT;
00237     <span class="keywordtype">int</span> timers_tol[RTAI_NR_CPUS];
00238 };
00239 
00240 <span class="keyword">struct </span>apic_timer_setup_data {
00241 
00242     <span class="keywordtype">int</span> mode;
00243     <span class="keywordtype">int</span> count;
00244 };
00245 
00246 <span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_times;
00247 
00248 <span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_smp_times[RTAI_NR_CPUS];
00249 
00250 <span class="keyword">extern</span> <span class="keyword">struct </span>calibration_data rtai_tunables;
00251 
00252 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_cpu_realtime;
00253 
00254 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_cpu_lock;
00255 
00256 <span class="keyword">extern</span> <span class="keyword">struct </span>rtai_switch_data {
00257     <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> depth;
00258     <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> oldflags;
00259 } rtai_linux_context[RTAI_NR_CPUS];
00260 
00261 <span class="keyword">extern</span> adomain_t rtai_domain;
00262 
00263 <span class="keyword">extern</span> <span class="keywordtype">int</span> rtai_adeos_ptdbase;
00264 
00265 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00266 <span class="preprocessor"></span>
00267 <span class="preprocessor">#ifdef CONFIG_PREEMPT</span>
00268 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_lock(lock)    do { barrier(); _raw_spin_lock(lock); barrier(); } while (0)</span>
00269 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock(lock)  do { barrier(); _raw_spin_unlock(lock); barrier(); } while (0)</span>
00270 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_PREEMPT */</span>
00271 <span class="preprocessor">#define rt_spin_lock(lock)    spin_lock(lock)</span>
00272 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock(lock)  spin_unlock(lock)</span>
00273 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_PREEMPT */</span>
00274 
00275 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_lock_irq(spinlock_t *lock) {
00276 
00277     rtai_cli();
00278     rt_spin_lock(lock);
00279 }
00280 
00281 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irq(spinlock_t *lock) {
00282 
00283     rt_spin_unlock(lock);
00284     rtai_sti();
00285 }
00286 
00287 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rt_spin_lock_irqsave(spinlock_t *lock) {
00288 
00289     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00290     rtai_save_flags_and_cli(flags);
00291     rt_spin_lock(lock);
00292     <span class="keywordflow">return</span> flags;
00293 }
00294 
00295 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irqrestore(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags, spinlock_t *lock) 
00296 {
00297         rt_spin_unlock(lock);
00298         rtai_local_irq_restore(flags);
00299 }
00300 
00301 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_get_global_lock(<span class="keywordtype">void</span>)
00302 {
00303         barrier();
00304         rtai_cli();
00305         <span class="keywordflow">if</span> (!test_and_set_bit(adeos_processor_id(), &amp;rtai_cpu_lock)) {
00306                 <span class="keywordflow">while</span> (test_and_set_bit(31, &amp;rtai_cpu_lock)) {
00307                         cpu_relax();
00308                 }
00309         }
00310         barrier();
00311 }
00312 
00313 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_release_global_lock(<span class="keywordtype">void</span>)
00314 {
00315         barrier();
00316         rtai_cli();
00317         <span class="keywordflow">if</span> (test_and_clear_bit(adeos_processor_id(), &amp;rtai_cpu_lock)) {
00318                 test_and_clear_bit(31, &amp;rtai_cpu_lock);
00319                 cpu_relax();
00320         }
00321         barrier();
00322 }
00323 
00336 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_cli(<span class="keywordtype">void</span>) 
00337 {
00338     rt_get_global_lock();
00339 }
00340 
00347 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_sti(<span class="keywordtype">void</span>) 
00348 {
00349     rt_release_global_lock();
00350     rtai_sti();
00351 }
00352 
00353 <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_save_flags_irqbit(<span class="keywordtype">void</span>)
00354 {
00355         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00356         rtai_save_flags(flags);
00357         <span class="keywordflow">return</span> flags &amp; (1 &lt;&lt; RTAI_IFLAG);
00358 }
00359 <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_save_flags_irqbit_and_cli(<span class="keywordtype">void</span>)
00360 {
00361         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00362         rtai_save_flags_and_cli(flags);
00363         <span class="keywordflow">return</span> flags &amp; (1 &lt;&lt; RTAI_IFLAG);
00364 }
00365 
00372 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_global_save_flags_and_cli(<span class="keywordtype">void</span>)
00373 {
00374         barrier();
00375         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags = rtai_save_flags_irqbit_and_cli();
00376 
00377         <span class="keywordflow">if</span> (!test_and_set_bit(adeos_processor_id(), &amp;rtai_cpu_lock)) {
00378                 <span class="keywordflow">while</span> (test_and_set_bit(31, &amp;rtai_cpu_lock)) {
00379                         cpu_relax();
00380                 }
00381                 barrier();
00382                 <span class="keywordflow">return</span> flags | 1;
00383         }
00384         barrier();
00385         <span class="keywordflow">return</span> flags;
00386 }
00387 
00395 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_save_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *flags)
00396 {
00397         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hflags = rtai_save_flags_irqbit_and_cli();
00398 
00399         *flags = test_bit(adeos_processor_id(), &amp;rtai_cpu_lock) ? hflags : hflags | 1;
00400         <span class="keywordflow">if</span> (hflags) {
00401                 rtai_sti();
00402         }
00403 }
00404 
00412 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_restore_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags)
00413 {
00414         barrier();
00415         <span class="keywordflow">switch</span> (flags &amp; ((1 &lt;&lt; RTAI_IFLAG) | 1)) {
00416                 <span class="keywordflow">case</span> (1 &lt;&lt; RTAI_IFLAG) | 1:
00417                         rt_release_global_lock();
00418                         rtai_sti();
00419                         <span class="keywordflow">break</span>;
00420                 <span class="keywordflow">case</span> (1 &lt;&lt; RTAI_IFLAG) | 0:
00421                         rt_get_global_lock();
00422                         rtai_sti();
00423                         <span class="keywordflow">break</span>;
00424                 <span class="keywordflow">case</span> (0 &lt;&lt; RTAI_IFLAG) | 1:
00425                         rt_release_global_lock();
00426                         <span class="keywordflow">break</span>;
00427                 <span class="keywordflow">case</span> (0 &lt;&lt; RTAI_IFLAG) | 0:
00428                         rt_get_global_lock();
00429                         <span class="keywordflow">break</span>;
00430         }
00431         barrier();
00432 }
00433 
00434 <span class="preprocessor">#else </span><span class="comment">/* !CONFIG_SMP */</span>
00435 
00436 <span class="preprocessor">#define rt_spin_lock(lock)</span>
00437 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock(lock)</span>
00438 <span class="preprocessor"></span>
00439 <span class="preprocessor">#define rt_spin_lock_irq(lock)    do { rtai_cli(); } while (0)</span>
00440 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock_irq(lock)  do { rtai_sti(); } while (0)</span>
00441 <span class="preprocessor"></span>
00442 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rt_spin_lock_irqsave(spinlock_t *lock)
00443 {
00444         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00445         rtai_save_flags_and_cli(flags);
00446         <span class="keywordflow">return</span> flags;
00447 }
00448 <span class="preprocessor">#define rt_spin_unlock_irqrestore(flags, lock)  do { rtai_restore_flags(flags); } while (0)</span>
00449 <span class="preprocessor"></span>
00450 <span class="preprocessor">#define rt_get_global_lock()      do { rtai_cli(); } while (0)</span>
00451 <span class="preprocessor"></span><span class="preprocessor">#define rt_release_global_lock()</span>
00452 <span class="preprocessor"></span>
00453 <span class="preprocessor">#define rt_global_cli()  do { rtai_cli(); } while (0)</span>
00454 <span class="preprocessor"></span><span class="preprocessor">#define rt_global_sti()  do { rtai_sti(); } while (0)</span>
00455 <span class="preprocessor"></span>
00456 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rt_global_save_flags_and_cli(<span class="keywordtype">void</span>)
00457 {
00458         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00459         rtai_save_flags_and_cli(flags);
00460         <span class="keywordflow">return</span> flags;
00461 }
00462 <span class="preprocessor">#define rt_global_restore_flags(flags)  do { rtai_restore_flags(flags); } while (0)</span>
00463 <span class="preprocessor"></span>
00464 <span class="preprocessor">#define rt_global_save_flags(flags)     do { rtai_save_flags(*flags); } while (0)</span>
00465 <span class="preprocessor"></span>
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>
00468 <span class="keywordtype">int</span> rt_printk(<span class="keyword">const</span> <span class="keywordtype">char</span> *format, ...);
00469 
00470 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_switch_to_real_time(<span class="keywordtype">int</span> cpuid)
00471 {
00472         TRACE_RTAI_SWITCHTO_RT(cpuid);
00473         <span class="keywordflow">if</span> (!rtai_linux_context[cpuid].depth++) {
00474                 rtai_linux_context[cpuid].oldflags = xchg(&amp;adp_root-&gt;cpudata[cpuid].status, (1 &lt;&lt; IPIPE_STALL_FLAG));
00475                 test_and_set_bit(cpuid, &amp;rtai_cpu_realtime);
00476         }
00477 }
00478 
00479 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_switch_to_linux(<span class="keywordtype">int</span> cpuid)
00480 {
00481         TRACE_RTAI_SWITCHTO_LINUX(cpuid);
00482         <span class="keywordflow">if</span> (rtai_linux_context[cpuid].depth) {
00483                 <span class="keywordflow">if</span> (!--rtai_linux_context[cpuid].depth) {
00484                         test_and_clear_bit(cpuid, &amp;rtai_cpu_realtime);
00485                         adp_root-&gt;cpudata[cpuid].status = rtai_linux_context[cpuid].oldflags;
00486                 }
00487                 <span class="keywordflow">return</span>;
00488         }
00489         rt_printk(<span class="stringliteral">"*** ERROR: EXCESS LINUX_UNLOCK ***\n"</span>);
00490 }
00491 
00492 <span class="preprocessor">#define in_hrt_mode(cpuid)  (test_bit(cpuid, &amp;rtai_cpu_realtime))</span>
00493 <span class="preprocessor"></span>
00494 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_set_timer_delay (<span class="keywordtype">int</span> delay) {
00495 
00496     <span class="comment">/* NOTE: delay MUST be 0 if a periodic timer is being used. */</span>
00497     <span class="keywordflow">if</span> (delay == 0) 
00498         {
00499 <span class="preprocessor">#ifdef CONFIG_40x</span>
00500 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
00501 <span class="preprocessor">#else  </span><span class="comment">/* !CONFIG_40x */</span>
00502         <span class="keywordflow">if</span> ((delay = rt_times.intr_time - rtai_rdtsc()) &lt;= 0)
00503             {
00504             <span class="keywordtype">int</span> lost = 0;
00505             <span class="keywordflow">do</span> 
00506                 {
00507                 lost++;
00508                 rt_times.intr_time += (RTIME)rt_times.periodic_tick;
00509                 }
00510             <span class="keywordflow">while</span> ((delay = rt_times.intr_time - rtai_rdtsc()) &lt;= 0);
00511             printk(<span class="stringliteral">"%d timer interrupt(s) lost\n"</span>, lost);
00512             }
00513 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_40x */</span>
00514         }
00515 <span class="preprocessor">#ifdef CONFIG_40x</span>
00516 <span class="preprocessor"></span>    mtspr(SPRN_PIT, delay);
00517 <span class="preprocessor">#else</span>
00518 <span class="preprocessor"></span>    set_dec(delay);
00519 <span class="preprocessor">#endif</span>
00520 <span class="preprocessor"></span>}
00521 
00522     <span class="comment">/* Private interface -- Internal use only */</span>
00523 
00524 <span class="preprocessor">#ifdef FIXME</span>
00525 <span class="preprocessor"></span><span class="keywordtype">void</span> rtai_attach_lxrt(<span class="keywordtype">void</span>);
00526 
00527 <span class="keywordtype">void</span> rtai_detach_lxrt(<span class="keywordtype">void</span>);
00528 
00529 <span class="keywordtype">void</span> rtai_switch_linux_mm(<span class="keyword">struct</span> task_struct *prev,
00530                           <span class="keyword">struct</span> task_struct *next,
00531                           <span class="keywordtype">int</span> cpuid);
00532 <span class="preprocessor">#endif</span>
00533 <span class="preprocessor"></span>
00534 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ &amp;&amp; !__cplusplus */</span>
00535 
00536     <span class="comment">/* Public interface */</span>
00537 
00538 <span class="preprocessor">#ifdef __KERNEL__</span>
00539 <span class="preprocessor"></span>
00540 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
00541 
00542 <span class="preprocessor">#ifdef __cplusplus</span>
00543 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00544 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00545 
00546 <span class="keywordtype">int</span> rt_request_irq(<span class="keywordtype">unsigned</span> irq, <span class="keywordtype">int</span> (*handler)(<span class="keywordtype">unsigned</span> irq, <span class="keywordtype">void</span> *cookie), <span class="keywordtype">void</span> *cookie, <span class="keywordtype">int</span> retmode);
00547 
00548 <span class="keywordtype">int</span> rt_release_irq(<span class="keywordtype">unsigned</span> irq);
00549 
00550 <span class="keywordtype">void</span> rt_set_irq_cookie(<span class="keywordtype">unsigned</span> irq,
00551                        <span class="keywordtype">void</span> *cookie);
00552 
00557 <span class="keywordtype">unsigned</span> <a class="code" href="group__hal.html#ga85">rt_startup_irq</a>(<span class="keywordtype">unsigned</span> irq);
00558 
00559 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga86">rt_shutdown_irq</a>(<span class="keywordtype">unsigned</span> irq);
00560 
00561 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga87">rt_enable_irq</a>(<span class="keywordtype">unsigned</span> irq);
00562 
00563 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga88">rt_disable_irq</a>(<span class="keywordtype">unsigned</span> irq);
00564 
00565 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga89">rt_mask_and_ack_irq</a>(<span class="keywordtype">unsigned</span> irq);
00566 
00567 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga90">rt_unmask_irq</a>(<span class="keywordtype">unsigned</span> irq);
00568 
00569 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga91">rt_ack_irq</a>(<span class="keywordtype">unsigned</span> irq);
00572 <span class="keywordtype">void</span> rt_do_irq(<span class="keywordtype">unsigned</span> irq);
00573 
00574 <span class="keywordtype">int</span> <a class="code" href="group__hal.html#ga93">rt_request_linux_irq</a>(<span class="keywordtype">unsigned</span> irq,
00575                          <span class="keywordtype">int</span> (*handler)(<span class="keywordtype">int</span> irq,
00576                          <span class="keywordtype">void</span> *dev_id,
00577                          <span class="keyword">struct</span> pt_regs *regs), 
00578                          <span class="keywordtype">char</span> *name,
00579                          <span class="keywordtype">void</span> *dev_id);
00580 
00581 <span class="keywordtype">int</span> <a class="code" href="group__hal.html#ga94">rt_free_linux_irq</a>(<span class="keywordtype">unsigned</span> irq,
00582                       <span class="keywordtype">void</span> *dev_id);
00583 
00584 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga95">rt_pend_linux_irq</a>(<span class="keywordtype">unsigned</span> irq);
00585 
00586 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga98">rt_pend_linux_srq</a>(<span class="keywordtype">unsigned</span> srq);
00587 
00588 <span class="keywordtype">int</span> <a class="code" href="group__hal.html#ga96">rt_request_srq</a>(<span class="keywordtype">unsigned</span> label,
00589                    <span class="keywordtype">void</span> (*k_handler)(<span class="keywordtype">void</span>),
00590                    <span class="keywordtype">long</span> <span class="keywordtype">long</span> (*u_handler)(<span class="keywordtype">unsigned</span>));
00591 
00592 <span class="keywordtype">int</span> <a class="code" href="group__hal.html#ga97">rt_free_srq</a>(<span class="keywordtype">unsigned</span> srq);
00593 
00594 <span class="keywordtype">int</span> rt_assign_irq_to_cpu(<span class="keywordtype">int</span> irq,
00595                          <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cpus_mask);
00596 
00597 <span class="keywordtype">int</span> rt_reset_irq_to_sym_mode(<span class="keywordtype">int</span> irq);
00598 
00599 <span class="keywordtype">void</span> rt_request_timer_cpuid(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00600                             <span class="keywordtype">unsigned</span> tick,
00601                             <span class="keywordtype">int</span> cpuid);
00602 
00603 <span class="preprocessor">#ifdef FIXME</span>
00604 <span class="preprocessor"></span><span class="keywordtype">void</span> rt_request_apic_timers(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00605                             <span class="keyword">struct</span> apic_timer_setup_data *tmdata);
00606 
00607 <span class="keywordtype">void</span> rt_free_apic_timers(<span class="keywordtype">void</span>);
00608 <span class="preprocessor">#endif</span>
00609 <span class="preprocessor"></span>
00610 <span class="keywordtype">int</span> <a class="code" href="group__hal.html#ga104">rt_request_timer</a>(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00611                      <span class="keywordtype">unsigned</span> tick,
00612                      <span class="keywordtype">int</span> use_apic);
00613 
00614 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga105">rt_free_timer</a>(<span class="keywordtype">void</span>);
00615 
00616 <span class="preprocessor">#ifdef FIXME</span>
00617 <span class="preprocessor"></span>RT_TRAP_HANDLER rt_set_trap_handler(RT_TRAP_HANDLER handler);
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>
00620 <span class="keywordtype">void</span> rt_mount(<span class="keywordtype">void</span>);
00621 
00622 <span class="keywordtype">void</span> rt_umount(<span class="keywordtype">void</span>);
00623 
00624 void (*rt_set_ihook(<span class="keywordtype">void</span> (*hookfn)(<span class="keywordtype">int</span>)))(int);
00625 
00626 <span class="preprocessor">#define rt_printk printk </span><span class="comment">/* This is safe over Adeos */</span>
00627 
00628 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_critical_enter(<span class="keywordtype">void</span> (*synch)(<span class="keywordtype">void</span>));
00629 
00630 <span class="keywordtype">void</span> rtai_critical_exit(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags);
00631 
00632 <span class="keywordtype">void</span> rtai_set_linux_task_priority(<span class="keyword">struct</span> task_struct *task, <span class="keywordtype">int</span> policy, <span class="keywordtype">int</span> prio);
00633 
00634 <span class="preprocessor">#ifdef __cplusplus</span>
00635 <span class="preprocessor"></span>}
00636 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00637 
00638 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00639 
00640 <span class="preprocessor">#include &lt;asm/rtai_oldnames.h&gt;</span>
00641 
00642 <span class="preprocessor">#define RTAI_DEFAULT_TICK    100000</span>
00643 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONFIG_RTAI_TRACE</span>
00644 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_DEFAULT_STACKSZ 8192</span>
00645 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_RTAI_TRACE */</span>
00646 <span class="preprocessor">#define RTAI_DEFAULT_STACKSZ 4092</span>
00647 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TRACE */</span>
00648 
00651 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_PPC_HAL_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Nov 17 12:29:17 2005 for RTAI API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
